<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Train Booking System</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 40px; background-color: #f4f7f6; color: #333; }
        #container { max-width: 800px; margin: 0 auto; padding: 20px; background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        h1, h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .auth-forms { display: flex; justify-content: space-between; gap: 20px; }
        .form-section { flex: 1; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        input[type="text"], input[type="password"] { width: 95%; padding: 8px; margin-bottom: 10px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #cities-list ul { list-style-type: none; padding-left: 0; }
        #cities-list li { background-color: #fafafa; padding: 10px; border-radius: 4px; margin-bottom: 8px; border: 1px solid #ddd; }
        .loading { color: #888; }
        .error { color: #d9534f; }
        .success { color: #28a745; }
        #user-status { background-color: #e6f7ff; border: 1px solid #b3e0ff; padding: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Welcome to the Train Booking System</h1>

        <div id="user-status">
            <p>You are not logged in.</p>
        </div>

        <div id="auth-section">
            <div class="auth-forms">
                <div class="form-section">
                    <h2>Login</h2>
                    <form id="login-form">
                        <input type="text" id="login-username" placeholder="Username" required>
                        <input type="password" id="login-password" placeholder="Password" required>
                        <button type="submit">Login</button>
                    </form>
                </div>
                
                <div class="form-section">
                    <h2>Register</h2>
                    <form id="register-form">
                        <input type="text" id="register-username" placeholder="Username" required>
                        <input type="password" id="register-password" placeholder="Password" required>
                        <button type="submit">Register</button>
                    </form>
                </div>
            </div>
            <p id="auth-message"></p>
        </div>

        <div id="app-section" style="display: none;">
            <button id="logout-button">Logout</button>
            <hr>
            <h2>Available Cities</h2>
            <div id="cities-list">
                <p class="loading">Loading cities...</p>
            </div>
            </div>
    </div>

    <script>
        // Store our app state
        const appState = {
            token: null
        };

        // --- DOM Elements ---
        const userStatusEl = document.getElementById('user-status');
        const authSectionEl = document.getElementById('auth-section');
        const appSectionEl = document.getElementById('app-section');
        const citiesListEl = document.getElementById('cities-list');
        const authMessageEl = document.getElementById('auth-message');
        const logoutButtonEl = document.getElementById('logout-button');
        const loginFormEl = document.getElementById('login-form');
        const registerFormEl = document.getElementById('register-form');

        // --- Functions ---

        /**
         * Updates the UI based on whether a user is logged in.
         */
        function updateUI() {
            appState.token = sessionStorage.getItem('authToken');
            
            if (appState.token) {
                // Logged In
                const username = sessionStorage.getItem('username');
                userStatusEl.innerHTML = `<p class="success">Welcome, <strong>${username}</strong>! You are logged in.</p>`;
                authSectionEl.style.display = 'none';
                appSectionEl.style.display = 'block';
                loadCities(); // Load cities now that we are logged in
            } else {
                // Logged Out
                userStatusEl.innerHTML = '<p>You are not logged in.</p>';
                authSectionEl.style.display = 'block';
                appSectionEl.style.display = 'none';
                citiesListEl.innerHTML = '<p class="loading">Please log in to see app content.</p>';
            }
        }

        /**
         * Fetches cities from our Flask API and displays them.
         */
        function loadCities() {
            citiesListEl.innerHTML = '<p class="loading">Loading cities...</p>';
            fetch('/api/cities')
                .then(response => response.json())
                .then(cities => {
                    if (cities.length === 0) {
                        citiesListEl.innerHTML = '<p>No cities found.</p>';
                        return;
                    }
                    citiesListEl.innerHTML = ''; 
                    let ul = document.createElement('ul');
                    cities.forEach(city => {
                        let li = document.createElement('li');
                        li.innerHTML = `<code>${city.city_code}</code> <strong>${city.city_name}</strong> (ID: ${city.city_id})`;
                        ul.appendChild(li);
                    });
                    citiesListEl.appendChild(ul);
                })
                .catch(err => {
                    citiesListEl.innerHTML = '<p class="error">Error loading cities.</p>';
                });
        }

        /**
         * Handles the login form submission.
         */
        loginFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            fetch('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.token) {
                    // Save token and username to browser session
                    sessionStorage.setItem('authToken', data.token);
                    sessionStorage.setItem('username', username);
                    authMessageEl.textContent = '';
                    updateUI(); // Refresh the page view
                } else {
                    authMessageEl.className = 'error';
                    authMessageEl.textContent = `Login Failed: ${data.message}`;
                }
            })
            .catch(err => {
                authMessageEl.className = 'error';
                authMessageEl.textContent = 'A network error occurred.';
            });
        });

        /**
         * Handles the registration form submission.
         */
        registerFormEl.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;

            fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: username, password: password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    authMessageEl.className = 'success';
                    authMessageEl.textContent = 'Registration successful! Please log in.';
                    registerFormEl.reset(); // Clear the form
                } else {
                    authMessageEl.className = 'error';
                    authMessageEl.textContent = `Registration Failed: ${data.message}`;
                }
            })
            .catch(err => {
                authMessageEl.className = 'error';
                authMessageEl.textContent = 'A network error occurred.';
            });
        });

        /**
         * Handles the logout button click.
         */
        logoutButtonEl.addEventListener('click', function() {
            // We just need to clear the session storage.
            // We could also call an /api/logout endpoint if we wanted to.
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('username');
            updateUI(); // Refresh the page view
        });

        // --- Initial Page Load ---
        // Check if the user is already logged in from a previous session
        updateUI();

    </script>
</body>
</html>